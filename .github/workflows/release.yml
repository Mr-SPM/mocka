name: Build and Release Chrome Extension

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      # å®‰è£… pnpm
      - name: Install pnpm
        run: |
          npm install -g pnpm
      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install

      # æ„å»º Chrome æ’ä»¶
      - name: Build Chrome extension
        run: npm run build


      # æ‰“åŒ… Chrome æ’ä»¶ä¸º zip
      - name: Zip Chrome extension
        run: |
          npm run zip
          mv dist/mocka.zip release/mocka-chrome.zip


      # ç”Ÿæˆç‰ˆæœ¬å·ï¼ˆä» package.json è·å–ï¼‰
      - name: Extract version
        id: version
        run: echo "VERSION=$(node -p 'require(\"./package.json\").version')" >> $GITHUB_ENV

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: "Extension v${{ env.VERSION }}"
          body: |
            ğŸš€ è‡ªåŠ¨æ„å»ºçš„æµè§ˆå™¨æ‰©å±•  
            âœ… Chrome å’Œ Firefox ä¸¤ç§ç‰ˆæœ¬å·²å‡†å¤‡å¥½ï¼š
            1. ä¸‹è½½ `mocka-chrome.zip` æˆ– `mocka-firefox.zip`
            2. è§£å‹ååœ¨æµè§ˆå™¨æ‰“å¼€ `chrome://extensions/` æˆ– `about:addons`ï¼ˆFirefoxï¼‰
            3. åœ¨â€œå¼€å‘è€…æ¨¡å¼â€ä¸­åŠ è½½è§£å‹åçš„æ–‡ä»¶å¤¹
          files: |
            release/mocka-chrome.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
