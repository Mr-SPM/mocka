name: Build and Release Chrome Extension

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # å®‰è£… pnpm
      - name: Install pnpm
        run: |
          npm install -g pnpm

      # å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: pnpm install

      # æ„å»º Chrome æ’ä»¶
      - name: Build Chrome extension
        run: npm run build

      # ç”Ÿæˆç‰ˆæœ¬å·
      - name: Extract version
        id: version
        run: echo "VERSION=$(node -p 'require(\"./package.json\").version')" >> $GITHUB_ENV

      # æ‰“åŒ… Chrome æ’ä»¶ä¸º zipï¼Œè¾“å‡ºæ–‡ä»¶åœ¨ .output ç›®å½•ä¸‹
      - name: Zip Chrome extension
        run: |
          npm run zip
          ls -la .output  # ç¡®è®¤æ–‡ä»¶è·¯å¾„å’Œå­˜åœ¨æ€§

      # åˆ›å»º GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: "Extension v${{ env.VERSION }}"
          body: |
            ğŸš€ è‡ªåŠ¨æ„å»ºçš„æµè§ˆå™¨æ‰©å±•  
            âœ… Chrome ç‰ˆæœ¬å·²å‡†å¤‡å¥½ï¼š
            1. ä¸‹è½½ `mocka-${{ env.VERSION }}-chrome.zip`
            2. è§£å‹ååœ¨æµè§ˆå™¨æ‰“å¼€ `chrome://extensions/`
            3. åœ¨â€œå¼€å‘è€…æ¨¡å¼â€ä¸­åŠ è½½è§£å‹åçš„æ–‡ä»¶å¤¹
          files: |
            .output/mocka-${{ env.VERSION }}-chrome.zip  # ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}  # ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œï¼ˆPATï¼‰
